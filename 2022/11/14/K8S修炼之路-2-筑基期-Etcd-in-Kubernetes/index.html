<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"foursevenlove.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Etcd in Kubernetes本阶段学习etcd与kubernetes，简单来说kubernetes可以看作一个应用，任何一个应用都要有数据库，kubernetes也不例外，而etcd就是kubernetes的数据库。 虽然etcd作为数据库是kubernetes的核心，但是在生产环境中并不直接和etcd打交道，而是通过API来操作资源。 这篇心法将介绍，etcd是如何工作的、工作流程及原理">
<meta property="og:type" content="article">
<meta property="og:title" content="K8S修炼之路-2.筑基期-Etcd in Kubernetes">
<meta property="og:url" content="https://foursevenlove.github.io/2022/11/14/K8S%E4%BF%AE%E7%82%BC%E4%B9%8B%E8%B7%AF-2-%E7%AD%91%E5%9F%BA%E6%9C%9F-Etcd-in-Kubernetes/index.html">
<meta property="og:site_name" content="foursevenlove">
<meta property="og:description" content="Etcd in Kubernetes本阶段学习etcd与kubernetes，简单来说kubernetes可以看作一个应用，任何一个应用都要有数据库，kubernetes也不例外，而etcd就是kubernetes的数据库。 虽然etcd作为数据库是kubernetes的核心，但是在生产环境中并不直接和etcd打交道，而是通过API来操作资源。 这篇心法将介绍，etcd是如何工作的、工作流程及原理">
<meta property="og:locale">
<meta property="og:image" content="https://raw.githubusercontent.com/foursevenlove/gitResource/master/Typora20220606164628.png">
<meta property="og:image" content="https://raw.githubusercontent.com/foursevenlove/gitResource/master/Typora20220606170311.png">
<meta property="og:image" content="https://raw.githubusercontent.com/foursevenlove/gitResource/master/Typora20220606170753.png">
<meta property="og:image" content="https://raw.githubusercontent.com/foursevenlove/gitResource/master/Typora20220606170846.png">
<meta property="og:image" content="https://raw.githubusercontent.com/foursevenlove/gitResource/master/Typora20220606221330.png">
<meta property="article:published_time" content="2022-11-14T08:05:51.000Z">
<meta property="article:modified_time" content="2022-11-17T12:08:46.840Z">
<meta property="article:author" content="foursevenlove">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="kube-ladder">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/foursevenlove/gitResource/master/Typora20220606164628.png">

<link rel="canonical" href="https://foursevenlove.github.io/2022/11/14/K8S%E4%BF%AE%E7%82%BC%E4%B9%8B%E8%B7%AF-2-%E7%AD%91%E5%9F%BA%E6%9C%9F-Etcd-in-Kubernetes/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>K8S修炼之路-2.筑基期-Etcd in Kubernetes | foursevenlove</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">foursevenlove</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/aboutMe/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://foursevenlove.github.io/2022/11/14/K8S%E4%BF%AE%E7%82%BC%E4%B9%8B%E8%B7%AF-2-%E7%AD%91%E5%9F%BA%E6%9C%9F-Etcd-in-Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/funs.jpg">
      <meta itemprop="name" content="foursevenlove">
      <meta itemprop="description" content="Keep on going never give up!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="foursevenlove">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          K8S修炼之路-2.筑基期-Etcd in Kubernetes
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-14 16:05:51" itemprop="dateCreated datePublished" datetime="2022-11-14T16:05:51+08:00">2022-11-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-17 20:08:46" itemprop="dateModified" datetime="2022-11-17T20:08:46+08:00">2022-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/kube-ladder/" itemprop="url" rel="index"><span itemprop="name">kube-ladder</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Etcd-in-Kubernetes"><a href="#Etcd-in-Kubernetes" class="headerlink" title="Etcd in Kubernetes"></a>Etcd in Kubernetes</h1><p>本阶段学习etcd与kubernetes，简单来说kubernetes可以看作一个应用，任何一个应用都要有数据库，kubernetes也不例外，而etcd就是kubernetes的数据库。</p>
<p>虽然etcd作为数据库是kubernetes的核心，但是在生产环境中并不直接和etcd打交道，而是通过API来操作资源。</p>
<p>这篇心法将介绍，etcd是如何工作的、工作流程及原理如何，以及在kubernetes中如何用到了etcd。<br><span id="more"></span></p>
<h2 id="1-k8s为啥要etcd？"><a href="#1-k8s为啥要etcd？" class="headerlink" title="1. k8s为啥要etcd？"></a>1. k8s为啥要etcd？</h2><p>一个Kuberbetes的集群从high level的层面来说，有三种不同类别的control-plane processes：</p>
<ul>
<li><strong>Centralized controllers</strong>：比如secheduler，controller-manager以及third-party controllers，用来配置pods和其他资源。</li>
<li><strong>Node-specific processes</strong>：最重要的一个是kubelet，用于处理根据配置来创建pod。</li>
<li><strong>API server</strong>：用来协调control plane processes和nodes。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/foursevenlove/gitResource/master/Typora20220606164628.png" style="zoom:80%;" /></p>
<p>每一个node都有kubelet，相当于是一个包工头，负责创建容器、挂载卷等任务。API是内部controller来联系kubelet的中介。</p>
<p>关于API server，其实工作量很少。当一个用户调用API时，API server:</p>
<ol>
<li>（用RBAC）来决定这次API调用是否被授权。</li>
<li>可能通过改变 webhook 更改 API 调用的负载。</li>
<li>判断负载是否有效。</li>
<li>将API负载持久化，并且返回请求信息。</li>
<li>可能会通知 API 端点的订阅者对象已更改。</li>
</ol>
<p>现在假设使用如下命令来部署三个Pod:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f deployment.yaml</span></span><br></pre></td></tr></table></figure>
<p>之后API server就会接收到这条请求，然后验证请求合法性，接着会将该deployment的定义保存到etcd中。</p>
<p><img src="https://raw.githubusercontent.com/foursevenlove/gitResource/master/Typora20220606170311.png" style="zoom:80%;" /></p>
<p>之后发生的任何事情都是由controllers以及node-specific processes来完成的，比如根据deployment决定需要运行哪些pod，每一个pod要调度运行在哪一个node上，设置networking等等。</p>
<p>在etcd中添加了该deployment之后，controller manager就会注意到来了新的资源。</p>
<p><img src="https://raw.githubusercontent.com/foursevenlove/gitResource/master/Typora20220606170753.png" style="zoom:80%;" /></p>
<p>然后Deployment and ReplicaSet controllers会在etcd中保存pods的信息。</p>
<p><img src="https://raw.githubusercontent.com/foursevenlove/gitResource/master/Typora20220606170846.png" style="zoom:80%;" /></p>
<p>从架构上抽象地来讲，API server就是一个CRUD的应用，对于这种应用来讲，总要有个数据库的支撑，那就是etcd了。</p>
<h2 id="2-为什么选择etcd"><a href="#2-为什么选择etcd" class="headerlink" title="2. 为什么选择etcd?"></a>2. 为什么选择etcd?</h2><p>数据库千千万，为何kubernetes选择了etcd作为数据库？能不能用Mysql或者PostgreSQL？答案是可以的，mysql或pg并不能最好的满足k8s的需求。问题就来了，k8s需要什么样的数据库呢？</p>
<h3 id="2-1-Consistency"><a href="#2-1-Consistency" class="headerlink" title="2.1 Consistency"></a>2.1 Consistency</h3><p>k8s的集群是分布式的，因此API server要求数据库必须保持强一致性。</p>
<h3 id="2-2-Availability"><a href="#2-2-Availability" class="headerlink" title="2.2 Availability"></a>2.2 Availability</h3><p>如果API server down了，那么整个k8s control plane就down了，因此数据库需要高可用。尽管不可能达到100%可用，但要尽量缩短downtime。</p>
<h3 id="2-3-Consistent-Performance"><a href="#2-3-Consistent-Performance" class="headerlink" title="2.3 Consistent Performance"></a>2.3 Consistent Performance</h3><p>API server可能同一时刻会接收到大量请求，因此性能也很重要。</p>
<h3 id="2-4-Change-Notification"><a href="#2-4-Change-Notification" class="headerlink" title="2.4 Change Notification"></a>2.4 Change Notification</h3><p>由于 API  server充当许多不同类型客户端之间的集中协调器，因此当数据库发生改变时，需要notification。</p>
<h3 id="2-5-Other-considerations"><a href="#2-5-Other-considerations" class="headerlink" title="2.5 Other considerations"></a>2.5 Other considerations</h3><p>上面是API server数据库需要的，下面这些是它不需要的：</p>
<ul>
<li><strong>Large Datasets</strong>：API server只保存pods等object的metadata，因此就算是一个很大的集群，metadata加起来可能会有几百兆，多一点几个G，但绝对达不到TB的量级。</li>
<li><strong>Complex Queries：</strong> k8s的API访问模式相对固定，一般通过类型，namespace或者name来获取，因此不需要很复杂的query。</li>
</ul>
<p>对于传统数据库来说，通常会在large datasets和complex queries上做很多优化，往往忽略了高可用和性能，而这恰恰不是k8s需要的，所以并不适合k8s。</p>
<h2 id="3-Etcd到底是啥？"><a href="#3-Etcd到底是啥？" class="headerlink" title="3 Etcd到底是啥？"></a>3 Etcd到底是啥？</h2><p><a target="_blank" rel="noopener" href="https://etcd.io/">Etcd</a>，是一个强一致性、分布式的key-value数据库。</p>
<ul>
<li><strong>强一致性</strong>：etcd具有严格的可串行化，这意味着一致的全局事件排序。也就是说，在一个客户端完成写之后，其余客户端读到的一定是写过之后的新值。</li>
<li><strong>分布式</strong>：和传统数据库不一样，etcd是设计成为不同node服务的数据库，也就是说有着高可用性。</li>
<li><strong>key-value</strong>：etcd的数据模型比较简单，采用key-value存储。</li>
</ul>
<p>除此之外，etcd一个最不一样的地方在于，k8s需要大量使用change notifications。etcd可以让客户端知道，哪一个或哪几个key发生了变化。</p>
<p>因为这些特性，k8s选择了etcd。当然了，不只etcd有这些特性，像<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/">Apache ZooKeeper</a> 和 <a target="_blank" rel="noopener" href="https://www.consul.io/">HashiCorpConsul</a>也有着相同特性。</p>
<h2 id="4-Etcd原理"><a href="#4-Etcd原理" class="headerlink" title="4 Etcd原理"></a>4 Etcd原理</h2><p>etcd之所以能够保持强一致性和高可用，是因为Raft算法。Raft算法解决的问题：多个独立的进程访问同一个数据的问题。这个问题叫做distributed consensus，相应的揭发还有一种叫Paxos算法，但是比较复杂并且实现起来困难。那Raft的优点就是简单理解，实现方便。关于Raft算法的流程以及原理可以参考这里，<a target="_blank" rel="noopener" href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a> ，按照这个图理解一遍应该就没问题了。 </p>
<p>通过上面链接中的动画演示，我们应该明白etcd集群中节点有哪些状态，节点间如何选举Leader，有了leader之后如何进行进行保持数据一致性的写操作。</p>
<p>简单总结一下Raft的流程：</p>
<p>首先应该明白在任意时刻，一个etcd集群应该有一个Leader，然后数据写操作应该是这么个流程：</p>
<ol>
<li>首先客户端向etcd集群中的任一节点发送写请求。</li>
<li>如果该节点恰好是leader，那么执行该写操作，并且将此次更新同步到其他节点的日志，日志更新后，在执行真正的写操作。</li>
<li>如果该节点是follower，那么要先将该请求转发到Leader，然后参考步骤2。</li>
<li>写操作完成后，向客户端返回ACK。</li>
</ol>
<p>如果etcd集群的leader由于某种原因掉线了，那么就要进行新一轮的选举，并且在大多数节点同意之后，才能选举成功。</p>
<p>etcd尽可能的保持了节点的可用，也就是说允许有节点是不可用的，那么底线在哪里？答案是看情况，大致可以参考：</p>
<p><img src="https://raw.githubusercontent.com/foursevenlove/gitResource/master/Typora20220606221330.png" style="zoom:80%;" /></p>
<p>通过观察可以看出，并不是说总节点数越多，可用性就越强。当节点数为3和4时，都只最多允许一个节点不可用，也就是说可用性是一样的。因此，etcd集群中节点数目通常采取奇数。</p>
<p>那么一个集群中应该设置多少个节点？答案还是看情况，这是一个tradeofff，可以说当节点数增加，有可能提高可用性，但是为了保持一致性，性能就会下降。一般来讲设置3个或5个。</p>
<h2 id="5-Etcd使用"><a href="#5-Etcd使用" class="headerlink" title="5. Etcd使用"></a>5. Etcd使用</h2><h3 id="5-1-安装及基本使用"><a href="#5-1-安装及基本使用" class="headerlink" title="5.1 安装及基本使用"></a>5.1 安装及基本使用</h3><p>Etcd提供了下载脚本，<a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases/，只要拷贝命令放在脚本里执行就好：">https://github.com/etcd-io/etcd/releases/，只要拷贝命令放在脚本里执行就好：</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ETCD_VER=v3.5.4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">choose either URL</span></span><br><span class="line">GOOGLE_URL=https://storage.googleapis.com/etcd</span><br><span class="line">GITHUB_URL=https://github.com/etcd-io/etcd/releases/download</span><br><span class="line">DOWNLOAD_URL=$&#123;GOOGLE_URL&#125;</span><br><span class="line"></span><br><span class="line">rm -f /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line">rm -rf /tmp/etcd-download-test &amp;&amp; mkdir -p /tmp/etcd-download-test</span><br><span class="line"></span><br><span class="line">curl -L $&#123;DOWNLOAD_URL&#125;/$&#123;ETCD_VER&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -o /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line">tar xzvf /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -C /tmp/etcd-download-test --strip-components=1</span><br><span class="line">rm -f /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">/tmp/etcd-download-test/etcd --version</span><br><span class="line">/tmp/etcd-download-test/etcdctl version</span><br><span class="line">/tmp/etcd-download-test/etcdutl version</span><br></pre></td></tr></table></figure>
<p>装好之后其实装了三个东西：</p>
<ul>
<li><strong>etcd</strong>：用于运行etcd server</li>
<li><strong>etcdctl</strong>：用于和server进行交互</li>
<li><strong>etcdutl</strong>：用于备份之类的操作</li>
</ul>
<p>直接使用etcd命令就可以启动一个单节点的etcd集群：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcd</span></span><br><span class="line">...</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;caller&quot;:&quot;etcdserver/server.go:2027&quot;,&quot;msg&quot;:&quot;published local member...&quot; &#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;caller&quot;:&quot;embed/serve.go:98&quot;,&quot;msg&quot;:&quot;ready to serve client requests&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;caller&quot;:&quot;etcdmain/main.go:47&quot;,&quot;msg&quot;:&quot;notifying init daemon&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;caller&quot;:&quot;etcdmain/main.go:53&quot;,&quot;msg&quot;:&quot;successfully notified init daemon&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;caller&quot;:&quot;embed/serve.go:140&quot;,&quot;msg&quot;:&quot;serving client traff...&quot;,&quot;address&quot;:&quot;127.0.0.1:2379&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>观察发现可以通过127.0.0.1:2379和集群进行交互。</p>
<p>需要注意的是，etcd的V2和V3差别很大，因此在使用<strong>etcdctl</strong>时需要指定使用的是哪个版本。通过环境变量来指定版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> ETCDCTL_API=3</span></span><br></pre></td></tr></table></figure>
<p>接着就可以使用etcdctl来读写数据了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl put foo bar</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl get foo</span></span><br><span class="line">foo</span><br><span class="line">bar</span><br></pre></td></tr></table></figure>
<p><code>etdctl get</code>会打印key和value，如果只想打印value可以加上<code>--print-value-only</code>。</p>
<p>可以加<code>-write-out=json</code>看到更详细的信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl get --write-out=json foo</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;header&quot;: &#123;</span><br><span class="line">    &quot;cluster_id&quot;: 14841639068965180000,</span><br><span class="line">    &quot;member_id&quot;: 10276657743932975000,</span><br><span class="line">    &quot;revision&quot;: 2,</span><br><span class="line">    &quot;raft_term&quot;: 2</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;kvs&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;key&quot;: &quot;Zm9v&quot;,</span><br><span class="line">      &quot;create_revision&quot;: 2,</span><br><span class="line">      &quot;mod_revision&quot;: 2,</span><br><span class="line">      &quot;version&quot;: 1,</span><br><span class="line">      &quot;value&quot;: &quot;YmFy&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;count&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>观察看到，打印出来的信息是base64编码的。</p>
<p>打印出来的信息啥意思呢？</p>
<ul>
<li><code>version：1</code></li>
<li><code>revision:2</code></li>
<li><code>create_revision：2</code></li>
<li><code>mod_revision：2</code></li>
</ul>
<p>根据<a target="_blank" rel="noopener" href="https://etcd.io/docs/v3.5/learning/api/">etcd documentation</a>，</p>
<p><code>version</code> 作用域为 key, 某一个 key 的修改次数(从创建到删除)；</p>
<p><code>revision</code>作用域为集群，逻辑时间戳，全局单调递增，任何 key 修改都会使其自增；</p>
<p><code>create_revision</code>作用域为 key, 等于创建这个 key 时的 Revision, 直到删除前都保持不变</p>
<p><code>mod_revision</code>作用域为 key, 等于修改这个 key 时的 Revision, 只要这个 key 更新都会改变。</p>
<p>当修改值之后，打印信息变化如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl put foo baz</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl get --write-out=json foo</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;header&quot;: &#123;</span><br><span class="line">    &quot;cluster_id&quot;: 14841639068965180000,</span><br><span class="line">    &quot;member_id&quot;: 10276657743932975000,</span><br><span class="line">    &quot;revision&quot;: 3,</span><br><span class="line">    &quot;raft_term&quot;: 2</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;kvs&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;key&quot;: &quot;Zm9v&quot;,</span><br><span class="line">      &quot;create_revision&quot;: 2,</span><br><span class="line">      &quot;mod_revision&quot;: 3,</span><br><span class="line">      &quot;version&quot;: 2,</span><br><span class="line">      &quot;value&quot;: &quot;YmF6&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;count&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>etcd并且支持查看旧版本数据，使用<code>--rev</code>参数来指定集群的版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl get foo --rev=2 --print-value-only</span></span><br><span class="line">bar</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl get foo --rev=3 --print-value-only</span></span><br><span class="line">baz</span><br></pre></td></tr></table></figure>
<p>删除数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcdctl del foo</span></span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl get foo</span></span><br></pre></td></tr></table></figure>
<p>删除后返回的1代表删除key数量。</p>
<p>但是删除并不是永久的，还是可以通过<code>--rev</code>参数来查看旧版本数据。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl get foo --rev=3 --print-value-only</span></span><br><span class="line">baz</span><br></pre></td></tr></table></figure>
<h3 id="5-2-多值返回"><a href="#5-2-多值返回" class="headerlink" title="5.2 多值返回"></a>5.2 多值返回</h3><p>etcd的一个特性就是可以一次返回多个value。</p>
<p>首先创建一些数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl put myprefix/key1 thing1</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl put myprefix/key2 thing2</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl put myprefix/key3 thing3</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl put myprefix/key4 thing4</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<p>一次访问多个值：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl get myprefix/key2 myprefix/key4</span></span><br><span class="line">myprefix/key2</span><br><span class="line">thing2</span><br><span class="line">myprefix/key3</span><br><span class="line">thing3</span><br></pre></td></tr></table></figure>
<p>可以通过<code>--prefix</code>来指定key的前缀：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl get --prefix myprefix/</span></span><br><span class="line">myprefix/key1</span><br><span class="line">thing1</span><br><span class="line">myprefix/key2</span><br><span class="line">thing2</span><br><span class="line">myprefix/key3</span><br><span class="line">thing3</span><br><span class="line">myprefix/key4</span><br><span class="line">thing4</span><br></pre></td></tr></table></figure>
<h3 id="5-3-监听修改"><a href="#5-3-监听修改" class="headerlink" title="5.3 监听修改"></a>5.3 监听修改</h3><p>首先在一个终端输入以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl watch --prefix myprefix/</span></span><br></pre></td></tr></table></figure>
<p>然后在另一个终端修改一些数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl put myprefix/key1 anewthing</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl put myprefix/key5 thing5</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl del myprefix/key5</span></span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl put notmyprefix/key thing</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<p>接着在第一个终端观察变化：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT</span><br><span class="line">myprefix/key1</span><br><span class="line">anewthing</span><br><span class="line">PUT</span><br><span class="line">myprefix/key5</span><br><span class="line">thing5</span><br><span class="line">DELETE</span><br><span class="line">myprefix/key5</span><br></pre></td></tr></table></figure>
<p>可以看到，因为监听了myprefix的数据，因此在第一个终端打印出了修改，而前缀notmyprefix并没有打印信息。</p>
<p>并且watch也可以加<code>--rev</code>参数来查看历史版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./etcdctl watch --rev=2 foo</span></span><br><span class="line">PUT</span><br><span class="line">foo</span><br><span class="line">bar</span><br><span class="line">PUT</span><br><span class="line">foo</span><br><span class="line">baz</span><br><span class="line">DELETE</span><br><span class="line">foo</span><br></pre></td></tr></table></figure>
<h3 id="5-4-多节点etcd集群"><a href="#5-4-多节点etcd集群" class="headerlink" title="5.4 多节点etcd集群"></a>5.4 多节点etcd集群</h3><p>目前未知，集群中只有一个节点，甚至不能称之为一个集群。现在我们来启动一个三节点的集群，来看看到底是怎么高可用的。</p>
<p>首先为三个节点创建数据保存的文件夹：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p /tmp/etcd/data&#123;1..3&#125;</span></span><br></pre></td></tr></table></figure>
<p>启动集群时，我们必须知道其中每一个节点的IP地址以及端口，这样节点之间才能相互通信。</p>
<p>对于三个节点，客户端的端口也就是客户端可以连接的端口设置为2379，3379和4379，peer端口也就是node之间通信的端口设置为2380，3380以及4380。</p>
<p>通过一下命令启动第一个节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./etcd --data-dir=/tmp/etcd/data1 --name node1 \</span><br><span class="line">  --initial-advertise-peer-urls http://127.0.0.1:2380 \</span><br><span class="line">  --listen-peer-urls http://127.0.0.1:2380 \</span><br><span class="line">  --advertise-client-urls http://127.0.0.1:2379 \</span><br><span class="line">  --listen-client-urls http://127.0.0.1:2379 \</span><br><span class="line">  --initial-cluster node1=http://127.0.0.1:2380,node2=http://127.0.0.1:3380,node3=http://127.0.0.1:4380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --initial-cluster-token mytoken</span><br></pre></td></tr></table></figure>
<p>其中几个参数：</p>
<ul>
<li><code>--name</code>：指定了节点的名字</li>
<li><code>--listen-peer-urls</code>和<code>--initial-advertise-peer-urls</code>：指定节点之间的通信地址和端口</li>
<li><code>--advertise-client-urls</code>和<code>--listen-client-urls</code>指定客户端与节点通信的地址和端口</li>
<li><code>--initial-cluster-token</code>指定一个集群中节点公用的token</li>
<li><code>--initial-cluster</code>指定集群中所有节点，这样才能找到其他节点</li>
</ul>
<p>同理在新的终端中启动第二个和第三个节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./etcd --data-dir=/tmp/etcd/data2 --name node2 \</span><br><span class="line">  --initial-advertise-peer-urls http://127.0.0.1:3380 \</span><br><span class="line">  --listen-peer-urls http://127.0.0.1:3380 \</span><br><span class="line">  --advertise-client-urls http://127.0.0.1:3379 \</span><br><span class="line">  --listen-client-urls http://127.0.0.1:3379 \</span><br><span class="line">  --initial-cluster node1=http://127.0.0.1:2380,node2=http://127.0.0.1:3380,node3=http://127.0.0.1:4380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --initial-cluster-token mytoken</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ </span><br><span class="line">bash</span><br><span class="line">./etcd --data-dir=/tmp/etcd/data3 --name node3 \</span><br><span class="line">  --initial-advertise-peer-urls http://127.0.0.1:4380 \</span><br><span class="line">  --listen-peer-urls http://127.0.0.1:4380 \</span><br><span class="line">  --advertise-client-urls http://127.0.0.1:4379 \</span><br><span class="line">  --listen-client-urls http://127.0.0.1:4379 \</span><br><span class="line">  --initial-cluster node1=http://127.0.0.1:2380,node2=http://127.0.0.1:3380,node3=http://127.0.0.1:4380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --initial-cluster-token mytoken</span><br></pre></td></tr></table></figure>
<p>启动之后，就可以使用etcdctl加上<code>--endpoint</code>参数来和节点通信，这里的endpoint就是启动时<code>--listen-client-urls</code>指定的地址。</p>
<p>首先查看所有节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> ENDPOINTS=127.0.0.1:2379,127.0.0.1:3379,127.0.0.1:4379</span><br><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> member list --write-out=table</span><br><span class="line">+------------------+---------+-------+-----------------------+-----------------------+------------+</span><br><span class="line">|        ID        | STATUS  | NAME  |      PEER ADDRS       |     CLIENT ADDRS      | IS LEARNER |</span><br><span class="line">+------------------+---------+-------+-----------------------+-----------------------+------------+</span><br><span class="line">| 3c969067d90d0e6c | started | node1 | http://127.0.0.1:2380 | http://127.0.0.1:2379 |      <span class="literal">false</span> |</span><br><span class="line">| 5c5501077e83a9ee | started | node3 | http://127.0.0.1:4380 | http://127.0.0.1:4379 |      <span class="literal">false</span> |</span><br><span class="line">| a2f3309a1583fba3 | started | node2 | http://127.0.0.1:3380 | http://127.0.0.1:3379 |      <span class="literal">false</span> |</span><br><span class="line">+------------------+---------+-------+-----------------------+-----------------------+------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>读写数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> put mykey myvalue</span><br><span class="line">OK</span><br><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> get mykey</span><br><span class="line">mykey</span><br><span class="line">myvalue</span><br></pre></td></tr></table></figure>
<p>现在假设一个节点down了咋办？我们在第一个终端中ctrl+c，然后查看节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> member list --write-out=table</span><br><span class="line">+------------------+---------+-------+-----------------------+-----------------------+------------+</span><br><span class="line">|        ID        | STATUS  | NAME  |      PEER ADDRS       |     CLIENT ADDRS      | IS LEARNER |</span><br><span class="line">+------------------+---------+-------+-----------------------+-----------------------+------------+</span><br><span class="line">| 3c969067d90d0e6c | started | node1 | http://127.0.0.1:2380 | http://127.0.0.1:2379 |      <span class="literal">false</span> |</span><br><span class="line">| 5c5501077e83a9ee | started | node3 | http://127.0.0.1:4380 | http://127.0.0.1:4379 |      <span class="literal">false</span> |</span><br><span class="line">| a2f3309a1583fba3 | started | node2 | http://127.0.0.1:3380 | http://127.0.0.1:3379 |      <span class="literal">false</span> |</span><br><span class="line">+------------------+---------+-------+-----------------------+-----------------------+------------+</span><br></pre></td></tr></table></figure>
<p>可以看到，就算杀掉了第一个节点，还是能看到三个节点。其实<code>meber list</code>列出了所有节点，可以采用<code>endpoint status</code>产看节点状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> endpoint status --write-out=table</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;level&quot;</span>: <span class="string">&quot;warn&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ts&quot;</span>: <span class="string">&quot;2021-06-23T15:43:40.378-0700&quot;</span>,</span><br><span class="line">  <span class="string">&quot;logger&quot;</span>: <span class="string">&quot;etcd-client&quot;</span>,</span><br><span class="line">  <span class="string">&quot;caller&quot;</span>: <span class="string">&quot;v3/retry_interceptor.go:62&quot;</span>,</span><br><span class="line">  <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;retrying of unary invoker failed&quot;</span>,</span><br><span class="line">  <span class="string">&quot;target&quot;</span>: <span class="string">&quot;etcd-endpoints://0xc000454700/#initially=[127.0.0.1:2379;127.0.0.1:3379;127.0.0.1:4379]&quot;</span>,</span><br><span class="line">  <span class="string">&quot;attempt&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;error&quot;</span>: <span class="string">&quot;rpc error: code = DeadlineExceeded ... connect: connection refused\&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">Failed to get the status of endpoint 127.0.0.1:2379 (context deadline exceeded)</span><br><span class="line">+----------------+------------------+-----------+------------+--------+</span><br><span class="line">|    ENDPOINT    |        ID        | IS LEADER | IS LEARNER | ERRORS |</span><br><span class="line">+----------------+------------------+-----------+------------+--------+</span><br><span class="line">| 127.0.0.1:3379 | a2f3309a1583fba3 |      <span class="literal">true</span> |      <span class="literal">false</span> |        |</span><br><span class="line">| 127.0.0.1:4379 | 5c5501077e83a9ee |     <span class="literal">false</span> |      <span class="literal">false</span> |        |</span><br><span class="line">+----------------+------------------+-----------+------------+--------+</span><br></pre></td></tr></table></figure>
<p>这时，集群还在work吗？应该吧，因为大多数节点还是健康的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> get mykey</span><br><span class="line">mykey</span><br><span class="line">myvalue</span><br><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> put mykey newvalue</span><br><span class="line">OK</span><br><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> get mykey</span><br><span class="line">mykey</span><br><span class="line">newvalue</span><br></pre></td></tr></table></figure>
<p>看起来一切正常。现在我们再重启使用第一条命令启动第一个节点的话，会发现它立马又重新加入了集群：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> endpoint status --write-out=table</span><br><span class="line">+----------------+------------------+-----------+------------+--------+</span><br><span class="line">|    ENDPOINT    |        ID        | IS LEADER | IS LEARNER | ERRORS |</span><br><span class="line">+----------------+------------------+-----------+------------+--------+</span><br><span class="line">| 127.0.0.1:2379 | 3c969067d90d0e6c |     <span class="literal">false</span> |      <span class="literal">false</span> |        |</span><br><span class="line">| 127.0.0.1:3379 | a2f3309a1583fba3 |      <span class="literal">true</span> |      <span class="literal">false</span> |        |</span><br><span class="line">| 127.0.0.1:4379 | 5c5501077e83a9ee |     <span class="literal">false</span> |      <span class="literal">false</span> |        |</span><br><span class="line">+----------------+------------------+-----------+------------+--------+</span><br></pre></td></tr></table></figure>
<p>万一两个节点都不可用了呢？现在杀掉第一个和第二个节点，再查看状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> endpoint status --write-out=table</span><br><span class="line">&#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;warn&quot;</span>,<span class="string">&quot;ts&quot;</span>:<span class="string">&quot;2021-06-23T15:47:05.803-0700&quot;</span>,<span class="string">&quot;logger&quot;</span>:<span class="string">&quot;etcd-client&quot;</span>,<span class="string">&quot;caller&quot;</span>:<span class="string">&quot;v3/retry_i ...&#125;</span></span><br><span class="line"><span class="string">Failed to get the status of endpoint 127.0.0.1:2379 (context deadline exceeded)</span></span><br><span class="line"><span class="string">&#123;&quot;</span>level<span class="string">&quot;:&quot;</span>warn<span class="string">&quot;,&quot;</span>ts<span class="string">&quot;:&quot;</span>2021-06-23T15:47:10.805-0700<span class="string">&quot;,&quot;</span>logger<span class="string">&quot;:&quot;</span>etcd-client<span class="string">&quot;,&quot;</span><span class="built_in">caller</span><span class="string">&quot;:&quot;</span>v3/retry_i ...&#125;</span><br><span class="line">Failed to get the status of endpoint 127.0.0.1:3379 (context deadline exceeded)</span><br><span class="line">+----------------+------------------+-----------+------------+-----------------------+</span><br><span class="line">|    ENDPOINT    |        ID        | IS LEADER | IS LEARNER |        ERRORS         |</span><br><span class="line">+----------------+------------------+-----------+------------+-----------------------+</span><br><span class="line">| 127.0.0.1:4379 | 5c5501077e83a9ee |     <span class="literal">false</span> |      <span class="literal">false</span> | etcdserver: no leader |</span><br><span class="line">+----------------+------------------+-----------+------------+-----------------------+</span><br></pre></td></tr></table></figure>
<p>可以看到报错信息是没有leader，这时尝试读写数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> get mykey</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;level&quot;</span>: <span class="string">&quot;warn&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ts&quot;</span>: <span class="string">&quot;2021-06-23T15:48:31.987-0700&quot;</span>,</span><br><span class="line">  <span class="string">&quot;logger&quot;</span>: <span class="string">&quot;etcd-client&quot;</span>,</span><br><span class="line">  <span class="string">&quot;caller&quot;</span>: <span class="string">&quot;v3/retry_interceptor.go:62&quot;</span>,</span><br><span class="line">  <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;retrying of unary invoker failed&quot;</span>,</span><br><span class="line">  <span class="string">&quot;target&quot;</span>: <span class="string">&quot;etcd-endpoints://0xc0001da000/#initially=[127.0.0.1:2379;127.0.0.1:3379;127.0.0.1:4379]&quot;</span>,</span><br><span class="line">  <span class="string">&quot;attempt&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;error&quot;</span>: <span class="string">&quot;rpc error: code = Unknown desc = context deadline exceeded&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> put mykey anewervalue</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;level&quot;</span>: <span class="string">&quot;warn&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ts&quot;</span>: <span class="string">&quot;2021-06-23T15:49:04.539-0700&quot;</span>,</span><br><span class="line">  <span class="string">&quot;logger&quot;</span>: <span class="string">&quot;etcd-client&quot;</span>,</span><br><span class="line">  <span class="string">&quot;caller&quot;</span>: <span class="string">&quot;v3/retry_interceptor.go:62&quot;</span>,</span><br><span class="line">  <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;retrying of unary invoker failed&quot;</span>,</span><br><span class="line">  <span class="string">&quot;target&quot;</span>: <span class="string">&quot;etcd-endpoints://0xc000432a80/#initially=[127.0.0.1:2379;127.0.0.1:3379;127.0.0.1:4379]&quot;</span>,</span><br><span class="line">  <span class="string">&quot;attempt&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;error&quot;</span>: <span class="string">&quot;rpc error: code = DeadlineExceeded desc = context deadline exceeded&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">Error: context deadline exceeded</span><br></pre></td></tr></table></figure>
<p>这时如果重新启动两个节点，马上一切又恢复了正常：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> endpoint status --write-out=table</span><br><span class="line">+----------------+------------------+-----------+------------+--------+</span><br><span class="line">|    ENDPOINT    |        ID        | IS LEADER | IS LEARNER | ERRORS |</span><br><span class="line">+----------------+------------------+-----------+------------+--------+</span><br><span class="line">| 127.0.0.1:2379 | 3c969067d90d0e6c |     <span class="literal">false</span> |      <span class="literal">false</span> |        |</span><br><span class="line">| 127.0.0.1:3379 | a2f3309a1583fba3 |     <span class="literal">false</span> |      <span class="literal">false</span> |        |</span><br><span class="line">| 127.0.0.1:4379 | 5c5501077e83a9ee |      <span class="literal">true</span> |      <span class="literal">false</span> |        |</span><br><span class="line">+----------------+------------------+-----------+------------+--------+</span><br><span class="line">$ ./etcdctl --endpoints=<span class="variable">$ENDPOINTS</span> get mykey</span><br><span class="line">mykey</span><br><span class="line">newvalue</span><br></pre></td></tr></table></figure>
<p>可以看到就算有downtime，也是没有数据丢失的。</p>
<h2 id="6-Etcd-in-k8s"><a href="#6-Etcd-in-k8s" class="headerlink" title="6. Etcd in k8s"></a>6. Etcd in k8s</h2><p>现在我们了解了etcd的基本使用，那么就来看看在k8s中etcd的使用吧。</p>
<p>这里我们采用minikube集群，连接minikube集群并且装上etcd：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ minikube start</span><br><span class="line">$ minikube ssh</span><br><span class="line">$ curl -LO https://mirrors.huaweicloud.com/etcd/v3.5.0/etcd-v3.5.0-linux-amd64.tar.gz</span><br><span class="line">$ tar xzvf etcd-v3.5.0-linux-amd64.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> etcd-v3.5.0-linux-amd64</span><br></pre></td></tr></table></figure>
<p>之后的步骤有一点不同，minikube的部署采用TLS验证，因此每次请求都要提供TLS的证书和keys。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> ETCDCTL=$(<span class="built_in">cat</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">sudo ETCDCTL_API=3 ./etcdctl --cacert /var/lib/minikube/certs/etcd/ca.crt </span></span><br><span class="line"><span class="string">  --cert /var/lib/minikube/certs/etcd/healthcheck-client.crt </span></span><br><span class="line"><span class="string">  --key /var/lib/minikube/certs/etcd/healthcheck-client.key</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>此处使用的证书和密钥是由 minikube 在 Kubernetes 集群引导期间生成的。它们是为与 etcd 健康检查一起使用而设计的，但它们也适用于调试。</p>
<p>查看节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="variable">$ETCDCTL</span> member list --write-out=table</span><br><span class="line">+------------------+---------+----------+---------------------------+---------------------------+------------+</span><br><span class="line">|        ID        | STATUS  |   NAME   |        PEER ADDRS         |       CLIENT ADDRS        | IS LEARNER |</span><br><span class="line">+------------------+---------+----------+---------------------------+---------------------------+------------+</span><br><span class="line">| aec36adc501070cc | started | minikube | https://192.168.49.2:2380 | https://192.168.49.2:2379 |      <span class="literal">false</span> |</span><br><span class="line">+------------------+---------+----------+---------------------------+---------------------------+------------+</span><br></pre></td></tr></table></figure>
<p>可以看到，minikube只有一个etcd节点。</p>
<p>Kubernetes API 是如何在etcd中保存数据的呢？所有k8s的数据都有<code>/registry</code>前缀：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="variable">$ETCDCTL</span> get --prefix /registry | <span class="built_in">wc</span> -l</span><br><span class="line">5882</span><br></pre></td></tr></table></figure>
<p>和pod有关的数据有着<code>/registry/pods</code>前缀：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="variable">$ETCDCTL</span> get --prefix /registry/pods | <span class="built_in">wc</span> -l</span><br><span class="line">412</span><br></pre></td></tr></table></figure>
<p>一般命名格式是这样：<code>/registry/pods/&lt;namespace&gt;/&lt;pod-name&gt;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="variable">$ETCDCTL</span> get --prefix /registry/pods/kube-system/ --keys-only | grep scheduler</span><br><span class="line">/registry/pods/kube-system/kube-scheduler-minikube</span><br></pre></td></tr></table></figure>
<p><code>--keys-only</code>只打印key。</p>
<p>实际数据长啥样呢？？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="variable">$ETCDCTL</span> get /registry/pods/kube-system/kube-scheduler-minikube | <span class="built_in">head</span> -6</span><br><span class="line">/registry/pods/kube-system/kube-scheduler-minikube</span><br><span class="line">k8s</span><br><span class="line"></span><br><span class="line">v1Pod�</span><br><span class="line">�</span><br><span class="line">kube-scheduler-minikube�</span><br><span class="line">                        kube-system<span class="string">&quot;*<span class="variable">$f8e4441d</span>-fb03-4c98-b48b-61a42643763a2��نZ</span></span><br></pre></td></tr></table></figure>
<p>可以看到是一堆乱码，因为k8s API是以二进制形式保存数据的。如果像查看json形式的话，应该用API而不是直接访问etcd。</p>
<p>可以采用watch来监听<code>default</code> ns的变化：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="variable">$ETCDCTL</span> watch --prefix /registry/pods/default/ --write-out=json</span><br></pre></td></tr></table></figure>
<p>然后在另一个终端：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run --namespace=default --image=nginx nginx</span><br><span class="line">pod/nginx created</span><br></pre></td></tr></table></figure>
<p>可以看到在第一个终端：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;Header&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cluster_id&quot;</span>: 18038207397139143000,</span><br><span class="line">    <span class="string">&quot;member_id&quot;</span>: 12593026477526643000,</span><br><span class="line">    <span class="string">&quot;revision&quot;</span>: 935,</span><br><span class="line">    <span class="string">&quot;raft_term&quot;</span>: 2</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;Events&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;kv&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;key&quot;</span>: <span class="string">&quot;L3JlZ2lzdHJ5L3BvZHMvZGVmYXVsdC9uZ2lueA==&quot;</span>,</span><br><span class="line">        <span class="string">&quot;create_revision&quot;</span>: 935,</span><br><span class="line">        <span class="string">&quot;mod_revision&quot;</span>: 935,</span><br><span class="line">        <span class="string">&quot;version&quot;</span>: 1,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;azh...ACIA&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;CompactRevision&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;Canceled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;Created&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次说明，在生产环境中并不会直接和etcd打交道，而是通过API来访问。可以预想的是，API底部也是通过etcd来读写数据的。</p>
<h2 id="7-替换etcd"><a href="#7-替换etcd" class="headerlink" title="7.替换etcd"></a>7.替换etcd</h2><p>在k8s中使用了etcd，但是在某些场合下比如测试环境或者嵌入式环境，我们想要轻量级，那etcd就不合适了。那么，就可以使用<a target="_blank" rel="noopener" href="https://k3s.io/">k3s</a>，并且使用你想使用的数据库。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"># k8s</a>
              <a href="/tags/kube-ladder/" rel="tag"># kube-ladder</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/14/K8S%E4%BF%AE%E7%82%BC%E4%B9%8B%E8%B7%AF-1-%E7%82%BC%E6%B0%94%E6%9C%9F/" rel="prev" title="K8S修炼之路-1. 炼气期">
      <i class="fa fa-chevron-left"></i> K8S修炼之路-1. 炼气期
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/14/K8S%E4%BF%AE%E7%82%BC%E4%B9%8B%E8%B7%AF-2-%E7%AD%91%E5%9F%BA%E6%9C%9F-kube-apiserver/" rel="next" title="K8S修炼之路-2.筑基期-kube-apiserver">
      K8S修炼之路-2.筑基期-kube-apiserver <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Etcd-in-Kubernetes"><span class="nav-text">Etcd in Kubernetes</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-k8s%E4%B8%BA%E5%95%A5%E8%A6%81etcd%EF%BC%9F"><span class="nav-text">1. k8s为啥要etcd？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9etcd"><span class="nav-text">2. 为什么选择etcd?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Consistency"><span class="nav-text">2.1 Consistency</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Availability"><span class="nav-text">2.2 Availability</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Consistent-Performance"><span class="nav-text">2.3 Consistent Performance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-Change-Notification"><span class="nav-text">2.4 Change Notification</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-Other-considerations"><span class="nav-text">2.5 Other considerations</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Etcd%E5%88%B0%E5%BA%95%E6%98%AF%E5%95%A5%EF%BC%9F"><span class="nav-text">3 Etcd到底是啥？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Etcd%E5%8E%9F%E7%90%86"><span class="nav-text">4 Etcd原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Etcd%E4%BD%BF%E7%94%A8"><span class="nav-text">5. Etcd使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E5%AE%89%E8%A3%85%E5%8F%8A%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-text">5.1 安装及基本使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%A4%9A%E5%80%BC%E8%BF%94%E5%9B%9E"><span class="nav-text">5.2 多值返回</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E7%9B%91%E5%90%AC%E4%BF%AE%E6%94%B9"><span class="nav-text">5.3 监听修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-%E5%A4%9A%E8%8A%82%E7%82%B9etcd%E9%9B%86%E7%BE%A4"><span class="nav-text">5.4 多节点etcd集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Etcd-in-k8s"><span class="nav-text">6. Etcd in k8s</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E6%9B%BF%E6%8D%A2etcd"><span class="nav-text">7.替换etcd</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="foursevenlove"
      src="/uploads/funs.jpg">
  <p class="site-author-name" itemprop="name">foursevenlove</p>
  <div class="site-description" itemprop="description">Keep on going never give up!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/foursevenlove" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;foursevenlove" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:foursevenlove@gmail.com" title="E-Mail → mailto:foursevenlove@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://blog.foursevenlove.top/" title="http:&#x2F;&#x2F;blog.foursevenlove.top" rel="noopener" target="_blank">Another Blog</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">foursevenlove</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
